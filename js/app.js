var Defalut = {
    title: '仿QQ群聊天界面',
    user: {
        number: '888888',
        nickname: '六个八',
        avatar: 'css/imgs/avatar.png',
        status: {
            show: true,
            vip: ''
        }
    },
    group: {
        number: '88888888',
        name: '一个正经的群名称',
        icon: 'css/imgs/icon.png',
        lineCount: '150',
        totalCount: '500'
    },
    notes: {
        show: true,
        data: [
            {
                types: '公告',
                title: '关于xxx的通知公告通知公告通知公告通知公告通知公告'
            },
            {
                types: '文件',
                title: '关于xxx的文件文件文件文件文件文件文件文件文件'
            }
        ]
    },
    members: [
        {
            nickname: '对方的季节',
            number: '654645445',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                vip: '1',
                qzone: true,
                qunzhu: true
            }
        },
        {
            nickname: '方法的方法',
            number: '54534',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                vip: '0',
                qzone: true,
                guanliyuan: true
            }
        },
        {
            nickname: '呵呵让他',
            number: '7676756',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '突然间好人',
            number: '876886',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                self: true
            }
        },
        {
            nickname: '国防观',
            number: '6756778',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '好的发挥',
            number: '533321',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '停用',
            number: '634563453',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '二如果',
            number: '35431533',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '啊D',
            number: '1120112',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '方式',
            number: '1123453435',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '沙发上',
            number: '57575',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '是否',
            number: '45542432453',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '方式',
            number: '434545',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: true,
                qzone: true
            }
        },
        {
            nickname: '是否',
            number: '34532142',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '库',
            number: '424232',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '有太阳',
            number: '17515560',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '原合同',
            number: '113887308',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '回帖',
            number: '717861',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '发的',
            number: '781878686',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '考录',
            number: '7657861',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '激活',
            number: '6786363',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '拉开距离',
            number: '776378678',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '让她',
            number: '4678678',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '统计好',
            number: '7867837',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '突然特',
            number: '774322',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '国防观',
            number: '31313',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '股份',
            number: '35633',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        },
        {
            nickname: '广汇股份',
            number: '186768',
            avatar: 'css/imgs/avatar.png',
            status: {
                show: false
            }
        }
    ],
    messages: [
        {
            nickname: '【管理员】',
            number: '98787897',
            sendtime: '2018/2/1 15:43:08',
            content: '来得及法律手段不就得了翻了就翻了，数控刀具福建省打开了杰弗里斯的看，法就是打开了放假了是的法律事件法律上飞机闪电不是都看风景。'
        },
        {
            nickname: '用户名',
            number: '734534543',
            sendtime: '2018/2/6 15:49:41',
            content: '十多个发的发生的发撒旦法谁的风格风格地，方广泛的古典风格电饭锅地方放歌地方'
        },
        {
            nickname: '看机会',
            number: '654654654',
            sendtime: '2018/2/6 15:45:00',
            content: '尽快了解克利夫兰解放军蓝色房间劳神费力受打击了封建时代雷锋精神方式决定了疯狂的世界发'
        }
    ]
};

var appStroe = {
    storeKey: 'fqqqljm',
    getStroe: function () {
        var store = JSON.parse(localStorage.getItem(this.storeKey)) || Defalut;
        return store;
    },
    updateStroe: function () {
        localStorage.setItem(this.storeKey, JSON.stringify(app._data));
    }
};

var app = new Vue({
    el: '#app',
    data: appStroe.getStroe(),
    watch: {
        user: {
            handler: function (newVal, oldVal) {
                if(newVal){
                    appStroe.updateStroe();
                }
            },
            deep: true
        },
        group: {
            handler: function (newVal, oldVal) {
                if(newVal){
                    appStroe.updateStroe();
                }
            },
            deep: true
        },
        members: {
            handler: function (newVal, oldVal) {
                if(newVal){
                    appStroe.updateStroe();
                }
            }
        },
        messages: function (newVal, oldVal) {
            if(newVal){
                appStroe.updateStroe();
            }
        },
        notes: {
            handler: function (newVal, oldVal) {
                if(newVal){
                    appStroe.updateStroe();
                }
            },
            deep:true
        }
    },
    mounted: function(){
        document.title = this.title;

        var oMsgList = document.querySelector('#msgList');

        if(oMsgList){
            oMsgList.addEventListener('DOMNodeInserted', function () {
                var oMsgListInner = document.querySelector('#msgListInner');
                if(this.clientHeight > oMsgListInner.clientHeight){
                    document.querySelector('#btnBackTop').style.display = 'block';
                    document.querySelector('#btnToBottom').style.display = 'block';
                }
                else{
                    document.querySelector('#btnBackTop').style.display = 'none';
                    document.querySelector('#btnToBottom').style.display = 'none';
                }
            });

            document.querySelector('#btnBackTop').addEventListener('click', function () {
                console.log(oMsgList.scrollHeight - oMsgList.clientHeight);
            });
            document.querySelector('#btnToBottom').addEventListener('click', function () {
                oMsgList.pageYOffset = oMsgList.clientHeight;
            });
        }

    },
    methods: {
        chagneGroupName: function (e) {
            this.group.name = e.target.innerHTML;
        },
        changeGroupIcon: function (e) {
            var _this = this;
            var file = e.target.files[0];
            var r = new FileReader();
            r.readAsDataURL(file);
            r.onload = function(){
                _this.group.icon = r.result;
            };
        },
        chagneGroupCount: function (type) {
            var value = 0;
            if(type === 'line'){
                value = parseInt(this.group.lineCount, 10);
                if(value < 0){
                    this.group.lineCount = 0;
                }
                else if(value > this.group.totalCount){
                    this.group.lineCount = this.group.totalCount;
                }
                else{
                    this.group.lineCount = value;
                }
            }
            else{
                value = parseInt(this.group.totalCount, 10);
                if(value < 200){
                    this.group.totalCount = 200;
                }
                else if(value > 200 && value <= 500){
                    this.group.totalCount = 500;
                }
                else if(value > 500 && value <= 1000){
                    this.group.totalCount = 1000;
                }
                else if(value > 1000){                    
                    this.group.totalCount = 2000;
                }
                else{                    
                    this.group.totalCount = 200;
                }

                if(this.group.lineCount > this.group.totalCount){
                    this.group.lineCount = this.group.totalCount;
                }
            }
        },
        getGroupNote: function (groupNumber) {
            // qid: 群号码;
            // http://web.qun.qq.com/cgi-bin/notice/get_data_new?qid=181514864&fnum=5
        },
        getMemberList: function () {
            var _this = this;
            $.ajax({
                url: 'data/qqspider/10.txt',
                type: 'post',
                data: {},
                success: function(res){
                    var _data = JSON.parse(res);
                    var aArr = [];
                    for(var i=0; i<_data.length; i++){
                        var oItem = {};
                        oItem.status = {};
                        for(var k in _data[i]){
                            if(_data[i]['nick']!=='' && _data[i]['uin']!==''){
                                console.log(_data[i]['nick'], _data[i]['uin']);
                                oItem['number'] = _data[i]['uin'];
                                oItem['nickname'] = _data[i]['nick'];
                                oItem['avatar'] = _data[i]['url'];
                                oItem['status']['vip'] = (_data[i]['age']%23 == 0);
                            }
                        }
                        if(oItem['nickname'] && oItem['number']){
                            aArr.push(oItem);
                        }
                    }
                    _this.members = aArr;
                },
                error: function(err){
                    console.log(err);
                }
            })
        },
        sendMessage: function () {
            var oMessage = document.querySelector('#message');
            if(oMessage.innerHTML.length>0){
                var nickname = '测试名';
                var number = '97897870';
                var sendtime = this.getDateTime();
                var content = oMessage.innerHTML;

                this.messages.push({
                    nickname: nickname,
                    number: number,
                    sendtime: sendtime,
                    content: content
                });

                console.log(this.messages);
                oMessage.innerHTML = '';
            }
            else{
                var aColor = ['rgb(250,233,233)','rgb(250,199,199)','rgb(250,216,216)','rgb(250,199,199)','rgb(250,250,250)'];
                var i = 0;
                clearInterval(timer);
                var timer=setInterval(function(){
                    if(i>aColor.length){
                        clearInterval(timer);
                    }else{
                        i++;
                    }
                    oMessage.style.backgroundColor = aColor[i];
                },100);
            }
        },
        setNotesShow: function(status){
            if(status === 1){
                this.notes.show = false;
                this.alert('关闭群通知！', 'success');
            }
            else{
                this.notes.show = true;
                this.alert('开启群通知！', 'success');
            }
        },
        generateApp: function(){
            this.getMemberList();
            console.log('已更新');
        },
        resetApp: function(){
            this.data = Defalut;
            console.log('已重置');
        },
        saveImage: function () {
            var oPreview = document.querySelector('#preview');
            var oSaveimg = document.createElement('div');
            oSaveimg.id = 'saveImg';
            oSaveimg.style.display = 'none';
            html2canvas(oPreview).then(function(canvas) {
                canvas.id = 'myCanvas';
                oSaveimg.innerHTML = '';
                oSaveimg.appendChild(canvas);
                document.body.appendChild(oSaveimg);

                //var oCanvas = document.querySelector('#myCanvas');
                Canvas2Image.saveAsPNG(canvas);
            });

        },
        getDateTime: function () {
            var oDate = new Date();
            var sYear = oDate.getFullYear();
            var sMonth = oDate.getMonth()+1 ;
            var sDay = oDate.getDate() ;
            var sHour = oDate.getHours()<10 ? '0'+oDate.getHours() : oDate.getHours();
            var sMinutes = oDate.getMinutes()<10 ? '0'+oDate.getMinutes() : oDate.getMinutes();
            var sSeconds = oDate.getSeconds()<10 ? '0'+oDate.getSeconds() : oDate.getSeconds();

            var sOutput = sYear +'/'+ sMonth +'/'+ sDay +' '+ sHour +':'+ sMinutes +':'+ sSeconds;

            return sOutput;
        },
        alert: function(msg, type){
            // type: success, info, warning, danger
            var oMain = document.querySelector('#main');
            var iIndex = 10 + document.querySelectorAll('.alert').length;

            var oAlert = document.createElement('div');
                oAlert.id = 'alert';
                oAlert.className = 'alert fade in alert-'+ type;
                oAlert.style.zIndex = iIndex;
                oAlert.setAttribute('role', 'alert');
/*                oAlert.innerHTML = '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\n' +
                    '  <span aria-hidden="true">&times;</span>\n' +
                    '</button>';*/
                oAlert.innerHTML = msg;

            oMain.insertBefore(oAlert, oMain.childNodes[0]);

            var timer = setTimeout(function(){
                if(oAlert){
                    oMain.removeChild(oAlert);
                }
            },1500);
        },
        getGTK: function (){
            var pSkey = 'u5psA6G*uWZxo0oyCcgeHLFJ6kWGGSwZoDzMShPcAKk_';
            var hash = 5381;
            for(var i = 0, len = pSkey.length; i < len; ++i)
            {
                hash += (hash << 5) + pSkey.charAt(i).charCodeAt();
            }
            return hash&0x7fffffff;
        }
    }
});


document.querySelector('#message').addEventListener('paste', function (e) {
    //onPasteEvent (e);
});

function onPasteEvent (e){
    if (e && e.clipboardData && e.clipboardData.getData)
    {
        if (/image/.test(e.clipboardData.types))
        {
            //粘贴图片
            var imageContent = e.clipboardData.getData('image/xxxx');
            alert(111111);
            //检测图片来源
            //如果是最原始的 data，比如 QQ 截图、Word 里复制所产生，直接把 data 上传
            //这一部分可能用了是 HTML5 中 HTTP_CONTENT_DISPOSITION 上传机制
            //除了 HTML5，非显式的 input[type="file"] 应该是无法上传文件的
            //如果是 file，上传到知乎服务器
            //如果是外部网站 URL，后台 curl get 转移到知乎服务器
            //最后生成一个知乎的 URL，作为 img 标签插入到 contentEditable div 中
        }
        else if (/text\/plain/.test(e.clipboardData.types)) {
            //粘贴简单文本 ....
            alert(222222);
        }
        else
        {
            //....
        }

        if (e.preventDefault)
        {
            e.stopPropagation();
            e.preventDefault();
        }
        return false;
    }
};

